########################################################################### 
# ���� Query
###########################################################################

#==============================================================
# �оߺ� ��� ��ȸ
#==============================================================
@sql.statistic.getStatCategory
SELECT C.CATEGORY1_ID, nvl(c.CATEGORY2_ID, 99999999) as CATEGORY2_ID, C.CATEGORY1_NM,C.CATEGORY2_NM, 
       NVL(Q1.total_cnt,0) AS total_cnt, NVL(Q2.online_cnt,0) AS online_cnt,
       NVL(Q3.offline_cnt,0) AS offline_cnt, NVL(Q4.answer_y_cnt,0) AS answer_y_cnt, NVL(Q5.answer_n_cnt,0) AS answer_n_cnt
FROM 
(
	SELECT A.CATEGORY_ID AS CATEGORY1_ID,
         NVL(b.CATEGORY_ID, '') AS CATEGORY2_ID,
         a.CATEGORY_NM AS CATEGORY1_NM, 
         b.CATEGORY_NM AS CATEGORY2_NM 
  FROM (SELECT CATEGORY_ID ,CATEGORY_NM, parent_id FROM RNDCALL_CATEGORY WHERE ISUSE='Y') a
        LEFT OUTER JOIN (SELECT CATEGORY_ID ,CATEGORY_NM, parent_id, order_no FROM RNDCALL_CATEGORY WHERE ISUSE='Y') b ON A.CATEGORY_ID = B.PARENT_ID
  WHERE a.parent_id = '-1'
  ORDER BY a.CATEGORY_ID, b.ORDER_NO ASC
) C LEFT OUTER JOIN 
(
    SELECT decode(category1,'','99999999',category1) AS category1, category2, COUNT(*) AS total_cnt
     FROM RNDCALL_BOARD_QUESTION
    WHERE board_type='QNA'
          AND INSERT_TYPE != 'TEL'
          AND DEL_YN='N'
          AND TO_CHAR(reg_dt,'yyyymm') BETWEEN ? AND ?
    GROUP BY decode(category1,'','99999999',category1), category2
) Q1 ON C.CATEGORY1_ID = Q1.CATEGORY1 AND C.CATEGORY2_ID = Q1.CATEGORY2
LEFT OUTER JOIN
 (
    SELECT decode(category1,'','99999999',category1) AS category1, category2, COUNT(*) AS online_cnt
    FROM RNDCALL_BOARD_QUESTION
    WHERE board_type='QNA'
          AND DEL_YN='N'
          AND INSERT_TYPE='ONLINE'   
          AND TO_CHAR(reg_dt,'yyyymm') BETWEEN ? AND ?
    GROUP BY decode(category1,'','99999999',category1), category2
) Q2 ON C.CATEGORY1_ID = Q2.CATEGORY1 AND C.CATEGORY2_ID = Q2.CATEGORY2
LEFT OUTER JOIN
 (
    SELECT decode(category1,'','99999999',category1) AS category1, category2, COUNT(*) AS offline_cnt
    FROM RNDCALL_BOARD_QUESTION
    WHERE board_type='QNA'
          AND DEL_YN='N'
          AND INSERT_TYPE='OFFLINE'
          AND TO_CHAR(reg_dt,'yyyymm') BETWEEN ? AND ?
    GROUP BY decode(category1,'','99999999',category1), category2
) Q3 ON C.CATEGORY1_ID = Q3.CATEGORY1 AND C.CATEGORY2_ID = Q3.CATEGORY2
LEFT OUTER JOIN
 (
    SELECT decode(category1,'','99999999',category1) AS category1,category2, COUNT(*) AS answer_y_cnt
    FROM RNDCALL_BOARD_QUESTION Q
    WHERE board_type='QNA'
          AND DEL_YN='N'
          AND INSERT_TYPE != 'TEL'
          AND EXISTS (SELECT 1 FROM RNDCALL_BOARD_ANSWER S WHERE Q.SEQ = S.Q_SEQ)
          AND TO_CHAR(reg_dt,'yyyymm') BETWEEN ? AND ?
    GROUP BY decode(category1,'','99999999',category1), category2
) Q4 ON C.CATEGORY1_ID = Q4.CATEGORY1 AND C.CATEGORY2_ID = Q4.CATEGORY2
LEFT OUTER JOIN
 (
    SELECT decode(category1,'','99999999',category1) AS category1, category2, COUNT(*) AS answer_n_cnt 
    FROM RNDCALL_BOARD_QUESTION Q
    WHERE board_type='QNA'
          AND DEL_YN='N'
          AND INSERT_TYPE != 'TEL'
          AND NOT EXISTS (SELECT 1 FROM RNDCALL_BOARD_ANSWER S WHERE Q.SEQ = S.Q_SEQ)
          AND TO_CHAR(reg_dt,'yyyymm') BETWEEN ? AND ?
    GROUP BY decode(category1,'','99999999',category1), category2
) Q5 ON C.CATEGORY1_ID = Q5.CATEGORY1 AND C.CATEGORY2_ID = Q5.CATEGORY2
ORDER BY CATEGORY1_ID, CATEGORY2_ID ASC   

      
#==============================================================
# �Ⱓ�� ��� ��ȸ
#==============================================================
@sql.statistic.getStatDate     
SELECT tot.mm,tot.CD_DTL_NM, total_cnt, online_cnt, offline_cnt ,answer_y_cnt,answer_n_cnt
FROM (
      SELECT TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5)) AS mm, B.CD_DTL_NM, NVL(total_cnt,'0') AS total_cnt
      FROM (
            SELECT TO_CHAR(Q.reg_dt,'mm') AS date_mm, COUNT(*) AS total_cnt FROM RNDCALL_BOARD_QUESTION Q
            WHERE Q.board_type='QNA'
                  AND Q.DEL_YN='N'
          AND Q.INSERT_TYPE != 'TEL'
                  AND TO_CHAR(Q.reg_dt,'yyyymm') BETWEEN ? AND ?
            GROUP BY TO_CHAR(Q.reg_dt,'mm')
            ) A RIGHT OUTER JOIN RNDCALL_CODE B ON A.DATE_MM = TO_NUMBER(SUBSTR(B.CD_DTL_ID, 3, 5))
      WHERE AND B.cd_id='100'
      ) tot LEFT OUTER JOIN 
      (
      SELECT TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5)) AS mm, B.CD_DTL_NM, NVL(online_cnt,'0') AS online_cnt
      FROM (
            SELECT TO_CHAR(Q.reg_dt,'mm') AS date_mm, COUNT(*) AS online_cnt FROM RNDCALL_BOARD_QUESTION Q
            WHERE Q.board_type='QNA'
                  AND Q.DEL_YN='N'
                  AND Q.INSERT_TYPE='ONLINE'
                  AND TO_CHAR(Q.reg_dt,'yyyymm') BETWEEN ? AND ?
            GROUP BY TO_CHAR(Q.reg_dt,'mm')
            ) A, RNDCALL_CODE B
      WHERE a.date_mm(+) = TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5))
            AND B.cd_id='100' 
      ) onL ON TOT.MM = ONL.MM
      LEFT OUTER JOIN
      (
      SELECT TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5)) AS mm, B.CD_DTL_NM, NVL(offline_cnt,'0') AS offline_cnt
      FROM (
            SELECT TO_CHAR(Q.reg_dt,'mm') AS date_mm, COUNT(*) AS offline_cnt FROM RNDCALL_BOARD_QUESTION Q
            WHERE Q.board_type='QNA'
                  AND Q.DEL_YN='N'
                  AND Q.INSERT_TYPE='OFFLINE'
                  AND TO_CHAR(Q.reg_dt,'yyyymm') BETWEEN ? AND ?
            GROUP BY TO_CHAR(Q.reg_dt,'mm')
            ) A RIGHT OUTER JOIN RNDCALL_CODE B ON a.date_mm = TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5))
      WHERE B.cd_id='100' 
      ) offL ON TOT.MM = OFFL.MM 
      LEFT OUTER JOIN
      (
      SELECT TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5)) AS mm, B.CD_DTL_NM, NVL(answer_y_cnt,'0') AS answer_y_cnt
      FROM (
            SELECT TO_CHAR(Q.reg_dt,'mm') AS date_mm, COUNT(*) AS answer_y_cnt FROM RNDCALL_BOARD_QUESTION Q
            WHERE Q.board_type='QNA'
                  AND Q.DEL_YN='N'
          AND Q.INSERT_TYPE != 'TEL'
                  AND EXISTS (SELECT 1 FROM RNDCALL_BOARD_ANSWER S WHERE Q.SEQ = S.Q_SEQ)
                  AND TO_CHAR(Q.reg_dt,'yyyymm') BETWEEN ? AND ?
            GROUP BY TO_CHAR(Q.reg_dt,'mm')
            ) A RIGHT OUTER JOIN RNDCALL_CODE B ON a.date_mm = TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5))
      WHERE B.cd_id='100' 
      ) answer_y ON TOT.MM = ANSWER_Y.MM
      LEFT OUTER JOIN
      (
      SELECT TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5)) AS mm, B.CD_DTL_NM, NVL(answer_n_cnt,'0') AS answer_n_cnt
      FROM (
            SELECT TO_CHAR(Q.reg_dt,'mm') AS date_mm, COUNT(*) AS answer_n_cnt FROM RNDCALL_BOARD_QUESTION Q
            WHERE Q.board_type='QNA'
                  AND Q.DEL_YN='N'
          AND Q.INSERT_TYPE != 'TEL'
                  AND NOT EXISTS (SELECT 1 FROM RNDCALL_BOARD_ANSWER S WHERE Q.SEQ = S.Q_SEQ)
                  AND TO_CHAR(Q.reg_dt,'yyyymm') BETWEEN ? AND ?
            GROUP BY TO_CHAR(Q.reg_dt,'mm')
            ) A RIGHT OUTER JOIN RNDCALL_CODE B a.date_mm = TO_NUMBER(SUBSTR(B.CD_DTL_ID,3,5))
      WHERE B.cd_id='100' 
      ) answer_n ON TOT.MM = ANSWER_N.MM
WHERE tot.mm BETWEEN ? AND ?
ORDER BY TO_NUMBER(tot.mm) asc



#==============================================================
# ��ü ������ ��� ��ȸ
#==============================================================
@sql.statistic.getVisitTotal
SELECT COUNT(*) AS CNT 
FROM RNDCALL_VISIT

#==============================================================
# �⵵�� ������ ��� ��ȸ
#==============================================================
@sql.statistic.getVisitYYrndcall
SELECT TO_NUMBER(TO_CHAR(visit_dt,'yyyy')) AS CODE, 
   	   COUNT(*) AS CNT 
FROM RNDCALL_VISIT
GROUP BY TO_NUMBER(TO_CHAR(visit_dt,'yyyy'))
@sql.statistic.getVisitYY
SELECT TO_NUMBER(TO_CHAR(visit_dt,'yyyy')) AS CODE, 
   COUNT(*) AS CNT 
FROM RNDCALL_VISIT
GROUP BY TO_NUMBER(TO_CHAR(visit_dt,'yyyy'))

 

#==============================================================
# �� ������ ��� ��ȸ
#==============================================================
@sql.statistic.getVisitMM

SELECT TO_NUMBER(TO_CHAR(A.visit_dt,'mm')) AS CODE, 
   	   COUNT(*) AS CNT 
FROM RNDCALL_VISIT A RIGHT OUTER JOIN RNDCALL_CODE B ON TO_NUMBER(TO_CHAR(A.VISIT_DT, 'MM')) = TO_NUMBER(SUBSTR(B.CD_DTL_ID, 3, 5))
WHERE B.CD_ID='100'
   	  AND B.USE_YN='Y' 



#==============================================================
# �Ϻ� ������ ��� ��ȸ
#==============================================================
@sql.statistic.getVisitDD 
SELECT TO_NUMBER(TO_CHAR(A.visit_dt,'dd')) AS CODE, 
   	   COUNT(*) AS CNT 
FROM RNDCALL_VISIT A RIGHT OUTER JOIN RNDCALL_CODE B ON TO_NUMBER(TO_CHAR(A.visit_dt,'dd')) = B.CD_DTL_ID
   	  WHERE B.CD_ID='101'
      AND B.USE_YN='Y' 
      
      
#==============================================================
# �оߺ� ��� �� ����Ʈ
#==============================================================
@sql.statistic.getStatList
SELECT  Q.SEQ,             Q.BOARD_TYPE,       Q.TITLE,            Q.CONTENTS,
	    Q.CELL_RECEIVE_YN, NVL(Q.CELL_NUMBER,'-') AS CELL_NUMBER,      Q.EMAIL_RECEIVE_YN, NVL(Q.EMAIL,'@') AS EMAIL,
	    NVL(Q.OPEN_YN,'Y') AS OPEN_YN,         NVL(Q.PUBLIC_TRANS_YN,'N') AS PUBLIC_TRANS_YN, Q.PUBLIC_TRANS_ID,  Q.INSERT_TYPE,
	    Q.NTIS_REG_ID,     Q.FILE_ID AS QUESTION_FILE_ID,          Q.DEL_YN,           Q.READ_COUNT,
	    Q.REG_ID,          Q.REG_DT,           TO_CHAR(Q.REG_DT,'yyyy.mm.dd') AS REG_DT1,           Q.REG_NM,           NVL(Q.CATEGORY1,'0000000') AS CATEGORY1,
	    NVL(Q.CATEGORY2,'0000000') AS CATEGORY2,
	    NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY1), '선택') AS CATEGORY1_NM, 
		NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY2), '선택') AS CATEGORY2_NM,
	    A.ANSWER_CONT, A.FILE_ID AS ANSWER_FILE_ID,
	    (CASE WHEN DECODE(A.SEQ,NULL,'N','Y')  = 'Y' THEN 'N'
              WHEN TO_CHAR(Q.REG_DT,'YYYYMMDD') < (TO_CHAR(sysdatetime,'YYYYMMDD')-1) THEN 'N'
              ELSE 'Y'
         END ) AS UP_DEL_STAT,
         DECODE(A.SEQ,NULL,'N','Y') AS STAT, NVL(A.SEQ,'0') AS ANSWER_SEQ
FROM RNDCALL_BOARD_QUESTION Q LEFT OUTER JOIN RNDCALL_BOARD_ANSWER A ON Q.SEQ = A.Q_SEQ
                                                      INNER JOIN  (SELECT category_id,DECODE(parent_id,-1, CATEGORY_ID, parent_id) AS parent_id  FROM RNDCALL_CATEGORY WHERE isuse='Y') C
                                                      ON Q.CATEGORY1 = C.PARENT_ID AND Q.CATEGORY2 = C.CATEGORY_ID
WHERE Q.DEL_YN='N'
      AND Q.BOARD_TYPE='QNA'
          AND Q.INSERT_TYPE != 'TEL'

#==============================================================
# �оߺ� ��� �� ����Ʈ
#==============================================================
@sql.statistic.getStatList1
SELECT  Q.SEQ,             Q.BOARD_TYPE,       Q.TITLE,            CLOB_TO_CHAR(Q.CONTENTS) AS CONTENTS,
Q.CELL_RECEIVE_YN, NVL(Q.CELL_NUMBER,'-') AS CELL_NUMBER,      Q.EMAIL_RECEIVE_YN, NVL(Q.EMAIL,'@') AS EMAIL,
NVL(Q.OPEN_YN,'Y') AS OPEN_YN,         NVL(Q.PUBLIC_TRANS_YN,'N') AS PUBLIC_TRANS_YN, Q.PUBLIC_TRANS_ID,  Q.INSERT_TYPE,
Q.NTIS_REG_ID,     Q.FILE_ID AS QUESTION_FILE_ID,          Q.DEL_YN,           Q.READ_COUNT,
Q.REG_ID,          Q.REG_DT,           TO_CHAR(Q.REG_DT,'yyyy.mm.dd') AS REG_DT1,           Q.REG_NM,           NVL(Q.CATEGORY1,'0000000') AS CATEGORY1,
NVL(Q.CATEGORY2,'0000000') AS CATEGORY2,
NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY1), '선택') AS CATEGORY1_NM, 
NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY2), '선택') AS CATEGORY2_NM
FROM RNDCALL_BOARD_QUESTION Q,  (SELECT category_id,DECODE(parent_id,-1, CATEGORY_ID, parent_id) AS parent_id  FROM RNDCALL_CATEGORY WHERE isuse='Y') C
WHERE Q.DEL_YN='N'
      AND Q.BOARD_TYPE='QNA'
          AND Q.INSERT_TYPE != 'TEL'
      AND C.PARENT_ID = Q.CATEGORY1
AND C.CATEGORY_ID = Q.CATEGORY2


#==============================================================
# �Ⱓ�� ��� �� ����Ʈ
#==============================================================
@sql.statistic.getStatList2 
SELECT  Q.SEQ,             Q.BOARD_TYPE,       Q.TITLE,            CLOB_TO_CHAR(Q.CONTENTS) AS CONTENTS,
Q.CELL_RECEIVE_YN, NVL(Q.CELL_NUMBER,'-') AS CELL_NUMBER,      Q.EMAIL_RECEIVE_YN, NVL(Q.EMAIL,'@') AS EMAIL,
NVL(Q.OPEN_YN,'Y') AS OPEN_YN,         NVL(Q.PUBLIC_TRANS_YN,'N') AS PUBLIC_TRANS_YN, Q.PUBLIC_TRANS_ID,  Q.INSERT_TYPE,
Q.NTIS_REG_ID,     Q.FILE_ID AS QUESTION_FILE_ID,          Q.DEL_YN,           Q.READ_COUNT,
Q.REG_ID,          Q.REG_DT,           TO_CHAR(Q.REG_DT,'yyyy.mm.dd') AS REG_DT1,           Q.REG_NM,           NVL(Q.CATEGORY1,'0000000') AS CATEGORY1,
NVL(Q.CATEGORY2,'0000000') AS CATEGORY2,
NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY1), '선택') AS CATEGORY1_NM, 
NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY2), '선택') AS CATEGORY2_NM,
A.ANSWER_CONT, A.FILE_ID AS ANSWER_FILE_ID,
(CASE WHEN DECODE(A.SEQ,NULL,'N','Y')  = 'Y' THEN 'N'
              WHEN TO_CHAR(Q.REG_DT,'YYYYMMDD') < (TO_CHAR(sysdatetime,'YYYYMMDD')-1) THEN 'N'
              ELSE 'Y'
         END ) AS UP_DEL_STAT,
         DECODE(A.SEQ,NULL,'N','Y') AS STAT, NVL(A.SEQ,'0') AS ANSWER_SEQ
FROM RNDCALL_BOARD_QUESTION Q LEFT OUTER JOIN RNDCALL_BOARD_ANSWER A ON Q.SEQ = A.Q_SEQ
WHERE Q.DEL_YN='N'
      AND Q.BOARD_TYPE='QNA'
      

#==============================================================
# �Ⱓ�� ��� �� ����Ʈ
#==============================================================
@sql.statistic.getStatList3
SELECT  Q.SEQ,             Q.BOARD_TYPE,       Q.TITLE,            Q.CONTENTS,
	    Q.CELL_RECEIVE_YN, NVL(Q.CELL_NUMBER,'-') AS CELL_NUMBER,      Q.EMAIL_RECEIVE_YN, NVL(Q.EMAIL,'@') AS EMAIL,
	    NVL(Q.OPEN_YN,'Y') AS OPEN_YN,         NVL(Q.PUBLIC_TRANS_YN,'N') AS PUBLIC_TRANS_YN, Q.PUBLIC_TRANS_ID,  Q.INSERT_TYPE,
	    Q.NTIS_REG_ID,     Q.FILE_ID AS QUESTION_FILE_ID,          Q.DEL_YN,           Q.READ_COUNT,
	    Q.REG_ID,          Q.REG_DT,           TO_CHAR(Q.REG_DT,'yyyy.mm.dd') AS REG_DT1,           Q.REG_NM,           NVL(Q.CATEGORY1,'0000000') AS CATEGORY1,
	    NVL(Q.CATEGORY2,'0000000') AS CATEGORY2,
	    NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY1), '선택') AS CATEGORY1_NM, 
		NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY2), '선택') AS CATEGORY2_NM
FROM RNDCALL_BOARD_QUESTION Q
WHERE Q.DEL_YN='N'
      AND Q.BOARD_TYPE='QNA'
	  
	  
#==============================================================
# �оߺ� ��� ������ ����Ʈ
#==============================================================
@sql.statistic.getStatView
SELECT  Q.SEQ,             Q.BOARD_TYPE,       Q.TITLE,            CLOB_TO_CHAR(Q.CONTENTS) AS CONTENTS,
Q.CELL_RECEIVE_YN, NVL(Q.CELL_NUMBER,'-') AS CELL_NUMBER,      Q.EMAIL_RECEIVE_YN, NVL(Q.EMAIL,'@') AS EMAIL,
NVL(Q.OPEN_YN,'Y') AS OPEN_YN,         NVL(Q.PUBLIC_TRANS_YN,'N') AS PUBLIC_TRANS_YN, Q.PUBLIC_TRANS_ID,  Q.INSERT_TYPE,
Q.NTIS_REG_ID,     Q.FILE_ID AS QUESTION_FILE_ID,          Q.DEL_YN,           Q.READ_COUNT,
Q.REG_ID,          Q.REG_DT,           TO_CHAR(Q.REG_DT,'yyyy.mm.dd') AS REG_DT1,           Q.REG_NM,           NVL(Q.CATEGORY1,'0000000') AS CATEGORY1,
NVL(Q.CATEGORY2,'0000000') AS CATEGORY2,
NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY1), '선택') AS CATEGORY1_NM, 
NVL((SELECT CATEGORY_NM FROM RNDCALL_CATEGORY WHERE CATEGORY_ID = Q.CATEGORY2), '선택') AS CATEGORY2_NM,
A.ANSWER_CONT, A.FILE_ID AS ANSWER_FILE_ID,
(CASE WHEN DECODE(A.SEQ,NULL,'N','Y')  = 'Y' THEN 'N'
              WHEN TO_CHAR(Q.REG_DT,'YYYYMMDD') < (TO_CHAR(sysdatetime,'YYYYMMDD')-1) THEN 'N'
              ELSE 'Y'
         END ) AS UP_DEL_STAT,
         DECODE(A.SEQ,NULL,'N','Y') AS STAT, NVL(A.SEQ,'0') AS ANSWER_SEQ
FROM RNDCALL_BOARD_QUESTION Q LEFT OUTER JOIN RNDCALL_BOARD_ANSWER A ON Q.SEQ = A.Q_SEQ
WHERE Q.DEL_YN='N' 
      